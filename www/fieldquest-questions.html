<link rel="import" href="components/core-toolbar/core-toolbar.html">
<link rel="import" href="components/core-selector/core-selector.html">
<link rel="import" href="components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="components/paper-fab/paper-fab.html">
<link rel="import" href="components/core-icons/image-icons.html">

<link rel="import" href="templates/fieldquest-question-single-select-item.html">
<link rel="import" href="templates/fieldquest-question-single-select-item-autocomplete.html">
<link rel="import" href="templates/fieldquest-question-date-picker.html">
<link rel="import" href="templates/fieldquest-question-multi-dropdown.html">
<link rel="import" href="templates/fieldquest-question-map-picker.html">
<link rel="import" href="templates/fieldquest-question-image-picker.html">
<link rel="import" href="templates/fieldquest-question-multiline-input.html">
<link rel="import" href="templates/fieldquest-question-geolocator.html">

<link rel="import" href="fieldquest-status-bar.html">

<!-- note: .question element has flex for IE10 compatibility -->
<polymer-element name="fieldquest-questions" attributes="allAnswers survey answers avatar wide" vertical layout>
<template>

  <link rel="stylesheet" href="fieldquest-questions.css">

  <div id="questionsPanel" class="questions-panel {{ {wide: wide} | tokenList }}" flex vertical layout?="{{!wide}}" slide-up?="{{parentElement.selected !== 'empty'}}" slide-down?="{{parentElement.selected === 'empty'}}">
  
    <div class="card {{ {answered: answered} | tokenList }}" flex?="{{!wide}}" vertical layout?="{{!wide}}" hero-p>
    
      <core-toolbar class="theme-bg" hero-id="punch-bottom" hero?="{{parentElement.selected !== 'empty'}}">
      
        <div class="question" flex cross-fade-delayed>{{question.question}}</div>
        
      </core-toolbar>

      <div id="questionsContent" class="questions-content" hidden?="{{!survey}}" flex hero-id="questions-content" hero?="{{parentElement.selected !== 'empty'}}">
      
        <core-selector id="questionViews" notap selected="{{question.type}}" cross-fade-delayed on-question-answered="{{questionAnswered}}" on-question-next="{{questionDone}}" on-core-select="{{selectionChangeComplete}}">
        
            <fieldquest-question-single-select-item name="single-select-item"></fieldquest-question-single-select-item>
            <fieldquest-question-single-select-item-autocomplete name="single-select-item-autocomplete"></fieldquest-question-single-select-item-autocomplete>
            <fieldquest-question-date-picker name="date-picker"></fieldquest-question-date-picker>
            <fieldquest-question-multi-dropdown name="multi-dropdown"></fieldquest-question-multi-dropdown>
            <fieldquest-question-map-picker name="map-picker" fit></fieldquest-question-map-picker>
            <fieldquest-question-image-picker name="image-picker"></fieldquest-question-image-picker>
            <fieldquest-question-multiline-input name="multiline-input"></fieldquest-question-multiline-input>
            <fieldquest-question-geolocator name="geolocator"></fieldquest-question-geolocator>
            
        </core-selector>

      </div>
      
      <paper-fab class="check-button-back {{ {show: index != 0} | tokenList }}" icon="image:navigate-before" on-tap="{{questionPrev}}"></paper-fab>
      <paper-fab class="check-button {{ {hide: isLastQuestion} | tokenList }}" icon="image:navigate-next" on-tap="{{questionDone}}"></paper-fab>
      
    </div>
    
  </div>

    <fieldquest-status-bar class="{{ {wide: wide} | tokenList }}" answers="{{answers}}" survey="{{survey}}" index="{{index}}" wide="{{wide}}" actionIcon="done" slide-up?="{{parentElement.selected === 'questions'}}" on-do-action="{{surveyDone}}"></fieldquest-status-bar>
</template>
<script>

  Polymer('fieldquest-questions', {
    
    wide: false,
    answered: false,
    isLastQuestion: false,
    isSurveyDone: false,
    avatar: 1,
    
    observe: {
        'survey': 'update'
    },

    created: function() {
        this.survey = {};
        this.answers = [];
    },
    
    resetScrollTop: function() {
      this.$.questionsPanel.scrollTop = 0;
      this.$.questionsContent.scrollTop = 0;
    },
      
    next: function() {
        if (!this.isLastQuestion) {
          this.index++;
          this.direction = 'next';
          this.answered = false;
        }
    },
      
    prev: function() {
        if (this.index != 0) {
            this.direction = 'prev';
            this.index--;
        }
    },
    
    seek: function(selectIndex) {
        this.index = selectIndex;
    },

    update: function() {
        if (this.answers && this.survey) {
            //Move to next unanswered question
            this.index = this.firstUnansweredQuestion();
            this.indexChanged();
        }
    },
      
    firstUnansweredQuestion: function() {
        //First Unanswered Question
        for (i = 0; i < this.answers.length; i++) {
            if (this.answers[i].answered == false) {
                return i;
            }
        }
        return this.answers.length - 1;
    },
      
    indexChanged: function() {
        if (this.index >= 0) {
            if (this.survey.questions) {
                if (this.index >= this.survey.questions.length - 1) {
                    //Handle index overrun
                    this.index = this.survey.questions.length - 1;
                    this.isLastQuestion = true;
                } else {
                    this.isLastQuestion = false;
                }
                var question = this.survey.questions[this.index];
                if (question.silent) {
                    this.silentQuestion(question);
                } else {
                    this.question = this.survey.questions[this.index];
                    this.answer = this.answers[this.index];
                }
            }
        }
    },
      
    questionChanged: function() {
      if (this.question) {
        this.questionView = this.$.questionViews.querySelector(
            '[name="' + this.question.type + '"]');
        if (this.questionView) {
            this.questionView.question = this.question;
            this.questionView.answer = this.answer;
            this.questionView.init();
        }
      }
    },
      
    silentQuestion: function(question) {
        this.questionView = this.$.questionViews.querySelector(
            '[name="' + question.type + '"]');
        if (this.questionView) {
            this.questionView.question = question;
            this.questionView.init();
            this.updateAnswers();
        }
        if (this.direction == 'next') {
            this.next();      
        } else {
            this.prev();
        }
    },
    
    questionDone: function() {
        this.updateAnswers();
        this.async(function() {
            this.fire('question-done', {});
        }, null, parseInt(CoreStyle.g.transitions.duration));
    },
      
    updateAnswers: function() {
        if (this.questionView) {
            var a = this.questionView.getAnswer();
            this.answers[this.index] = a;
            this.allAnswers[this.survey.name] = this.answers;

            this.async(function() {
                this.fire('answers-changed', {});
          }, null, parseInt(CoreStyle.g.transitions.duration));
        }
    },
      
    questionPrev: function() {
        this.updateAnswers();
        this.async(function() {
            this.fire('question-prev', {});
      }, null, parseInt(CoreStyle.g.transitions.duration));
    },
    
    questionAnswered: function() {
        this.answered = true;
        this.updateAnswers();
    },
      
    surveyDone: function() {
        this.updateAnswers();
                this.async(function() {
            this.fire('survey-done', {});
      }, null, parseInt(CoreStyle.g.transitions.duration));
    },
      
    loadAnswers: function() {
        if (this.allAnswers[this.survey.name]) {    
            this.answers = this.allAnswers[this.survey.name];
        } else {
            this.answers = [];
        }
    },
      
    selectionChangeComplete: function(event) {
        if (event.detail.isSelected) {
            this.questionRendered();
        }
    },
      
    questionRendered: function() {
        if (this.questionView) {
            this.questionView.rendered();
        }
    }
    
  });

</script>
</polymer-element>
